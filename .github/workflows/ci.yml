name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff==0.1.14

      - name: Run ruff linter
        run: ruff check .

      - name: Run ruff formatter check
        run: ruff format --check .

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run mypy
        run: mypy agent_readiness_audit

  test:
    name: Test
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        run: pytest --cov=agent_readiness_audit --cov-report=term-missing

  lint-config:
    name: Lint Config Files
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install ruff==0.1.14

      - name: Lint Python files with Ruff
        run: |
          ruff check .

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v14
        with:
          globs: '**/*.md'
        continue-on-error: true

      - name: Lint Shell scripts
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.claude/hooks'
        continue-on-error: true

      - name: Lint Python hooks
        run: |
          ruff check .claude/hooks
        continue-on-error: true

  validate-config:
    name: Validate Configuration
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          for file in $(find . -name "*.json" -type f); do
            echo "Validating $file"
            python3 -m json.tool "$file" > /dev/null || echo "Invalid JSON: $file"
          done

      - name: Validate TOML files
        run: |
          pip install toml
          python3 -c "
          import toml
          import sys
          try:
              toml.load('.claude/bootstrap.toml')
              print('bootstrap.toml is valid')
          except Exception as e:
              print(f'Invalid TOML: {e}')
              sys.exit(1)
          "

      - name: Check required files exist
        run: |
          required_files=(
            "CLAUDE.md"
            "README.md"
            ".claude/settings.json"
            ".claude/bootstrap.toml"
            ".claude/commands/plan.md"
            ".claude/commands/qa.md"
            ".claude/commands/ship.md"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Missing required file: $file"
              exit 1
            fi
          done
          echo "All required files present"

  hooks-executable:
    name: Verify Hooks Executable
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4

      - name: Check hook permissions
        run: |
          for hook in .claude/hooks/*.sh .claude/hooks/*.py; do
            if [ -f "$hook" ]; then
              if [ ! -x "$hook" ]; then
                echo "Warning: $hook is not executable"
              else
                echo "$hook is executable"
              fi
            fi
          done

  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4

      - name: Check for broken internal links
        run: |
          # Simple check for referenced files
          grep -roh '\[.*\](.*.md)' *.md .claude/**/*.md 2>/dev/null | \
          grep -oP '\(.*?\)' | tr -d '()' | \
          while read link; do
            if [[ "$link" != http* ]] && [ ! -f "$link" ]; then
              echo "Possibly broken link: $link"
            fi
          done || true

      - name: Verify source repo URL is correct
        run: |
          # Ensure the source repo URL is consistently referenced
          grep -r "bigdegenenergy/ai-dev-toolkit" . --include="*.md" | head -20
          echo "Source repository references found above"
